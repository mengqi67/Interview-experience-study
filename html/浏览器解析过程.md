<!--
 * @Author: ymq
 * @Date: 2021-12-21 16:29:23
 * @LastEditTime: 2021-12-22 20:14:45
 * @LastEditors: ymq
 * @Description: 
-->

# 浏览器解析html的过程 / html渲染原理

假设html结构为：

```html
<html>
    <head>
        <meta name="viewport" content="xxx">
        <link href="https://baidu.com/xxx/index.css">
    </head>
    <body>
        <div>解析解析</div>
        <p>加油加油</p>
        <script src="/index.js"></script>
    </body>
</html>
```

通过浏览器解析原理，分析上述html：

当浏览器通过url，从服务器取到html文件后，首先解析dom元素，用于生成DomTree；

解析html -> head -> meta

当解析到link标签时，去下载css文件，但不会阻塞dom元素向下解析；

body -> div -> p

假设css文件此时下载完成，解析css文件，生成CSSOM (dom和CSSOM都完成后会触发DOMContentLoaded事件)

当遇到script标签时，会阻塞html解析，等待js文件加载，执行（因为js代码可能会改变dom树的结构，因此要等待js执行结束，得到一个稳定的domtree）

js执行完之后，根据domTree和CSSOM生成renderTree (display: none的元素不会出现在渲染树上，visibility:hidden的元素可以出现在渲染树上)

然后进行layout布局

最后painting绘制


当js放在head内，link前，10秒后返回（或同步返回），并需要执行10秒钟，页面在执行结束后展示，DOMContentLoaded和load事件都是js执行结束后触发

当js放在dom最后 同步返回，但是需要执行10秒时，页面在执行完才展示
当js放在dom最后 10秒后返回，但是需要执行10秒时，页面可以先展示 `为什么js是阻塞渲染的 还能展示页面？`



现代浏览器会进行prefetch优化，在获得html文档后会对页面上引用的资源进行提前下载（只下载 并不是解析）


css文件不会阻塞dom解析，但它会阻塞页面渲染

将css文件设置15秒返回，js文件设置10秒返回，页面DOMContentLoaded和load事件都是在15秒后执行，也就是说css文件返回后，渲染的页面。控制台在15秒后打印内容，说明即使js加载完成，也要等css加载完成后才能执行（CSSSOM构建完成后才能执行js）

html内的其他资源比如img，video，不会阻塞解析，也不会阻塞渲染，但是它会阻塞lode事件的触发。
如果图片资源加载的慢，页面已经渲染，没有给img预留位置，就会发生回流

reflow: 回流
当浏览器发现某个元素发生了变化影响了布局，需要重新渲染，就会触发回流。我们常用的交互操作比如折叠，展开，等影响到元素的尺寸，位置，定位方式等，都会触发回流。

repaint: 重绘
当元素的背景色，文字颜色，边框颜色等发生变化，但尺寸没有变化时，会触发重绘。
